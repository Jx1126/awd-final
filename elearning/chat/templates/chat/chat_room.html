{% extends "base.html" %}

{% load widget_tweaks %}

{% block title %}Chat Room{% endblock %}

{% block content %}

<textarea id="message_log" rows="20" cols="100" class="block mb-10 mx-4 p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 pointer-events-none" placeholder="No messages yet.."></textarea>

<label for="input_message" class="sr-only">Your message</label>
<div class="flex items-center px-3 py-2 mb-10 rounded-lg bg-gray-50">
  <textarea id="input_message" rows="1" class="block mx-4 p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"  placeholder="Your message..."></textarea>
  <button type="submit" id="send_message" class="inline-flex justify-center p-2 text-blue-600 rounded-full cursor-pointer hover:bg-blue-100">
    <svg class="w-5 h-5 rotate-90 rtl:-rotate-90" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 20"><path d="m17.914 18.594-8-18a1 1 0 0 0-1.828 0l-8 18a1 1 0 0 0 1.157 1.376L8 18.281V9a1 1 0 0 1 2 0v9.281l6.758 1.689a1 1 0 0 0 1.156-1.376Z"/></svg>
    <span class="sr-only">Send message</span>
  </button>
</div>

{{ room_name|json_script:"room-name" }}

<script>
  const chat_room_name = JSON.parse(document.getElementById("room-name").textContent);
  console.log('Connecting to WebSocket at ws://' + window.location.host + '/ws/user/chat/' + chat_room_name + '/');
  const chat_socket = new WebSocket('ws://' + window.location.host + '/ws/user/chat/' + chat_room_name + '/');

  chat_socket.onmessage = function(event) {
     const data = JSON.parse(event.data);
     document.getElementById("message_log").value += (data.message + '\n');
  }

  chat_socket.onclose = function(event) {
    console.error('Chat socket closed unexpectedly');
  }

  document.getElementById("input_message").focus();
  document.getElementById("input_message").onkeyup = function(event) {
    if (event.key === "Enter") {
      document.getElementById("send_message").click();
    }
  }

  document.getElementById("send_message").onclick = function(event) {
    const message_dom = document.getElementById("input_message");
    const message = message_dom.value;
    chat_socket.send(JSON.stringify({
      'message': message
    }));
    message_dom.value = '';
  }
</script>

{% endblock %}